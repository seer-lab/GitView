 @@ -336,7 +336,7 @@ private void serializeNullValue(ParseContext context, String lastFieldName) thro
         }
     }

-    private void serializeObject(ParseContext context, String currentFieldName) throws IOException {
+    private void serializeObject(final ParseContext context, String currentFieldName) throws IOException {
         context.path().add(currentFieldName);

         XContentMapper objectMapper = mappers.get(currentFieldName);
@@ -367,6 +367,14 @@ private void serializeObject(ParseContext context, String currentFieldName) thro
                         objectMapper = builder.build(builderContext);
                         putMapper(objectMapper);

+                        // we need to traverse in case we have a dynamic template and need to add field mappers
+                        // introduced by it
+                        objectMapper.traverse(new FieldMapperListener() {
+                            @Override public void fieldMapper(FieldMapper fieldMapper) {
+                                context.docMapper().addFieldMapper(fieldMapper);
+                            }
+                        });
+
                         // now re add it and parse...
                         context.path().add(currentFieldName);
                         objectMapper.parse(context);  

--------------------------------------------------------------------------------------
1 Line is modified
8 Lines of new code
